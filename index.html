<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>fisuMapBaires</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #1a1a1a; color: #fff; }
    #mapContainer { height: 80vh; width: 100%; }
    #modeTitle { text-align: center; margin: 10px 0; }
    #addPointBtn { position: absolute; top: 10px; right: 10px; z-index: 1000; padding: 5px 10px; background: #333; color: #fff; border: none; }
    #pointForm { display: none; position: absolute; top: 50px; left: 10px; z-index: 1000; background: #333; padding: 10px; border: 1px solid #555; color: #fff; }
    #pointDetails { display: none; position: absolute; bottom: 10px; left: 10px; right: 10px; z-index: 1000; background: #333; padding: 10px; border: 1px solid #555; color: #fff; }
    #photoContainer { display: flex; flex-wrap: nowrap; justify-content: flex-start; width: 100%; overflow-x: auto; padding: 5px 0; }
    #photoContainer img { height: 100px; margin: 0 5px; cursor: pointer; }
    #imageOverlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
    #imageOverlay img { max-width: 90%; max-height: 90%; border: 5px solid; }
    #layerControls { position: absolute; top: 50px; right: 10px; z-index: 1000; background: #333; padding: 10px; border: 1px solid #555; color: #fff; }
    .custom-popup { max-width: 250px; background: #333; color: #fff; }
    input, select, textarea, button { background: #444; color: #fff; border: 1px solid #666; }
    #savingMessage { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3000; background: #444; padding: 10px; border: 1px solid #666; }
  </style>
</head>
<body>
  <h2 id="modeTitle">fisuMapBaires - Modo Visor</h2>
  <button id="addPointBtn" onclick="toggleMode()">Agregar Punto</button>
  <div id="mapContainer"></div>
  <div id="pointForm">
    <label for="layerSelect">Categoría:</label>
    <select id="layerSelect">
      <option value="fisuras">Fisuras</option>
      <option value="limpieza">Limpieza</option>
      <option value="trapitos">Trapitos</option>
      <option value="narcomenudeo">Narcomenudeo</option>
      <option value="casas-tomadas">Casas Tomadas</option>
      <option value="comercios-fisuras">Comercios Fisuras</option>
      <option value="via-publica">Vía Pública</option>
    </select><br>
    <label for="userInput">Usuario:</label>
    <input type="text" id="userInput" placeholder="Anónimo"><br>
    <label for="titleInput">Título:</label>
    <input type="text" id="titleInput"><br>
    <label for="descriptionInput">Descripción:</label>
    <textarea id="descriptionInput"></textarea><br>
    <label for="photoInput">Fotos (máx. 5):</label>
    <input type="file" id="photoInput" accept="image/*" multiple><br>
    <button id="submitBtn" onclick="submitPoint()">Enviar Punto</button>
  </div>
  <div id="pointDetails">
    <div id="photoContainer"></div>
  </div>
  <div id="imageOverlay" onclick="hideOverlay()"></div>
  <div id="layerControls">
    <h3>Capas</h3>
    <label><input type="checkbox" id="fisurasCheck" checked onchange="updateLayers()"> <span style="color: red">Fisuras</span></label><br>
    <label><input type="checkbox" id="limpiezaCheck" checked onchange="updateLayers()"> <span style="color: green">Limpieza</span></label><br>
    <label><input type="checkbox" id="trapitosCheck" checked onchange="updateLayers()"> <span style="color: yellow">Trapitos</span></label><br>
    <label><input type="checkbox" id="narcomenudeoCheck" checked onchange="updateLayers()"> <span style="color: purple">Narcomenudeo</span></label><br>
    <label><input type="checkbox" id="casas-tomadasCheck" checked onchange="updateLayers()"> <span style="color: orange">Casas Tomadas</span></label><br>
    <label><input type="checkbox" id="comercios-fisurasCheck" checked onchange="updateLayers()"> <span style="color: pink">Comercios Fisuras</span></label><br>
    <label><input type="checkbox" id="via-publicaCheck" checked onchange="updateLayers()"> <span style="color: gray">Vía Pública</span></label><br>
    <label><input type="checkbox" id="comisariasCheck" checked onchange="updateLayers()"> <span style="color: blue">Comisarías</span></label><br>
    <button onclick="selectAllLayers()">Ver todo</button>
    <button onclick="deselectAllLayers()">Ninguna</button>
  </div>
  <div id="savingMessage">Guardando punto, por favor esperá...</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    let latitude, longitude;
    let currentMarker = null;
    let isEditing = false;
    const map = L.map('mapContainer').setView([-34.6, -58.4], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    const iconBase = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-';
    const icons = {
      'fisuras': L.icon({ iconUrl: `${iconBase}red.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
      'limpieza': L.icon({ iconUrl: `${iconBase}green.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
      'trapitos': L.icon({ iconUrl: `${iconBase}yellow.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
      'narcomenudeo': L.icon({ iconUrl: `${iconBase}violet.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
      'casas-tomadas': L.icon({ iconUrl: `${iconBase}orange.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
      'comercios-fisuras': L.icon({ iconUrl: `${iconBase}pink.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
      'via-publica': L.icon({ iconUrl: `${iconBase}grey.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
      'comisarias': L.icon({ iconUrl: `${iconBase}blue.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] })
    };

    const layersConfig = {
      'fisuras': { color: 'red', fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/1cb1d8e5bf02d884ae4dd0cca5c7ca97/raw/fisuras-fija.geojson', tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/ca1084559d9fc6c5a91a6175d424bd2c/raw/fisuras-temporal.geojson' },
      'limpieza': { color: 'green', fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/2c3d4d9e4a21d504b2c268debc71f8ec/raw/limpieza-fija.geojson', tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/52640ef61feae0ba47fa5c1b50a4bb03/raw/limpieza-temporal.geojson' },
      'trapitos': { color: 'yellow', fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/3a03f67f71c4a786a77e02272627ca05/raw/trapitos-fija.geojson', tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/4b5ae0b59d4cbbad161f0234906cb1cd/raw/trapitos-temporal.geojson' },
      'narcomenudeo': { color: 'purple', fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/5efc8ea5b5a449f028a6a52fa198dbb5/raw/narcomenudeo-fija.geojson', tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/363f43d4842fa35a3357ae2c474a6fff/raw/narcomenudeo-temporal.geojson' },
      'casas-tomadas': { color: 'orange', fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/302f0ad335f67a6e636191a63d7eb14d/raw/casasTomadas-fija.geojson', tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/9a74c688f462688e1d712989c275d853/raw/casasTomadas-temporal.geojson' },
      'comercios-fisuras': { color: 'pink', fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/b9007a080910fab28432b60de9478e6a/raw/comerciosFisura-fija.geojson', tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/3a1ca4ff9425fbac6d887aba7e414f98/raw/comerciosFisura-temporal.geojson' },
      'via-publica': { color: 'gray', fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/daa897ed4fbfba087549e4abea37412c/raw/viaPublica-fija.geojson', tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/79af8d490561594d4bd4f739ae5e9356/raw/viaPublica-temporal.geojson' },
      'comisarias': { color: 'blue', fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/33d1ed2480106a5f6e044720607b01cc/raw/comisarias.geojson', tempUrl: null }
    };

    const clusterGroups = {};
    Object.keys(layersConfig).forEach(layer => {
      clusterGroups[layer] = L.markerClusterGroup({
        iconCreateFunction: cluster => {
          return L.divIcon({
            html: `<span style="background-color: ${layersConfig[layer].color}">${cluster.getChildCount()}</span>`,
            className: 'marker-cluster',
            iconSize: L.point(40, 40)
          });
        }
      });
    });

    function createPopupContent(title, user) {
      return `<b>${title}</b><br>Usuario: ${user}`;
    }

    function showDetails(imageUrls, layer) {
      if (!isEditing) {
        document.getElementById('pointDetails').style.display = 'block';
        const photoContainer = document.getElementById('photoContainer');
        photoContainer.innerHTML = '';
        imageUrls.forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.onclick = () => showOverlay(url, layer);
          photoContainer.appendChild(img);
        });
      }
    }

    function hideOverlay() {
      document.getElementById('imageOverlay').style.display = 'none';
    }

    function showOverlay(url, layer) {
      const overlay = document.getElementById('imageOverlay');
      overlay.innerHTML = `<img src="${url}" style="border-color: ${layersConfig[layer].color}">`;
      overlay.style.display = 'flex';
    }

    function hideDetails() {
      document.getElementById('pointDetails').style.display = 'none';
    }

    async function loadPoints() {
      for (const layer in layersConfig) {
        const config = layersConfig[layer];
        clusterGroups[layer].clearLayers();

        try {
          const fixedResponse = await fetch(config.fixedUrl);
          const fixedData = await fixedResponse.json();
          L.geoJSON(fixedData, {
            pointToLayer: (feature, latlng) => {
              return L.marker(latlng, { icon: icons[layer] });
            },
            onEachFeature: (feature, layerFeature) => {
              const { name, description, user } = feature.properties;
              const imageUrls = description.match(/{{https:\/\/i\.imgur\.com\/\w+\.(?:jpg|png|jpeg|gif)}}/g)?.map(url => url.slice(2, -2)) || [];
              layerFeature.bindPopup(createPopupContent(name, user), { className: 'custom-popup' });
              layerFeature.on('click', (e) => {
                showDetails(imageUrls, layer);
                L.DomEvent.stopPropagation(e);
              });
            }
          }).addTo(clusterGroups[layer]);
        } catch (e) { console.log(`No hay datos fijos para ${layer}`); }

        if (config.tempUrl) {
          try {
            const tempResponse = await fetch(config.tempUrl);
            const tempData = await tempResponse.json();
            L.geoJSON(tempData, {
              pointToLayer: (feature, latlng) => {
                return L.marker(latlng, { icon: icons[layer] });
              },
              onEachFeature: (feature, layerFeature) => {
                const { name, description, user } = feature.properties;
                const imageUrls = description.match(/{{https:\/\/i\.imgur\.com\/\w+\.(?:jpg|png|jpeg|gif)}}/g)?.map(url => url.slice(2, -2)) || [];
                layerFeature.bindPopup(createPopupContent(name, user), { className: 'custom-popup' });
                layerFeature.on('click', (e) => {
                  showDetails(imageUrls, layer);
                  L.DomEvent.stopPropagation(e);
                });
              }
            }).addTo(clusterGroups[layer]);
          } catch (e) { console.log(`No hay datos temporales para ${layer}`); }
        }

        if (document.getElementById(`${layer}Check`).checked) {
          clusterGroups[layer].addTo(map);
        }
      }
    }

    function enableMapClick() {
      map.on('click', (event) => {
        if (isEditing) {
          latitude = event.latlng.lat;
          longitude = event.latlng.lng;
          if (currentMarker) map.removeLayer(currentMarker);
          currentMarker = L.marker([latitude, longitude]).addTo(map);
        } else {
          hideDetails();
        }
      });
    }

    function disableMapClick() {
      map.off('click');
      if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
      }
    }

    function toggleMode() {
      if (isEditing) {
        isEditing = false;
        document.getElementById('modeTitle').textContent = 'fisuMapBaires - Modo Visor';
        document.getElementById('pointForm').style.display = 'none';
        document.getElementById('addPointBtn').textContent = 'Agregar Punto';
        document.getElementById('pointDetails').style.display = 'none';
        document.getElementById('layerControls').style.display = 'block';
        disableMapClick();
        enableMapClick();
        document.getElementById('userInput').value = '';
        document.getElementById('titleInput').value = '';
        document.getElementById('descriptionInput').value = '';
        document.getElementById('photoInput').value = '';
      } else {
        isEditing = true;
        document.getElementById('modeTitle').textContent = 'fisuMapBaires - Modo Edición';
        document.getElementById('pointForm').style.display = 'block';
        document.getElementById('addPointBtn').textContent = 'Volver a Visor';
        document.getElementById('pointDetails').style.display = 'none';
        document.getElementById('layerControls').style.display = 'none';
        enableMapClick();
      }
    }

    async function submitPoint() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      document.getElementById('savingMessage').style.display = 'block';

      const layer = document.getElementById('layerSelect').value;
      const user = document.getElementById('userInput').value || 'Anónimo';
      const title = document.getElementById('titleInput').value;
      const description = document.getElementById('descriptionInput').value;
      const photoInput = document.getElementById('photoInput');
      const files = Array.from(photoInput.files).slice(0, 5); // Máximo 5 fotos

      if (!latitude || !longitude) {
        alert('Hacé clic en el mapa para elegir una ubicación antes de enviar.');
        submitBtn.disabled = false;
        document.getElementById('savingMessage').style.display = 'none';
        return;
      }

      if (!title) {
        alert('Ingresá un título para el punto.');
        submitBtn.disabled = false;
        document.getElementById('savingMessage').style.display = 'none';
        return;
      }

      let imageUrls = [];
      if (files.length > 0) {
        for (const file of files) {
          const formData = new FormData();
          formData.append('image', file);
          try {
            const response = await fetch('https://api.imgur.com/3/image', {
              method: 'POST',
              headers: { Authorization: 'Client-ID 724f0aaea5b4c6b' },
              body: formData
            });
            const data = await response.json();
            if (data.success) imageUrls.push(data.data.link);
            else console.error('Error en Imgur:', data);
          } catch (e) {
            console.error('Error en Imgur:', e);
          }
        }
      } else {
        imageUrls.push('https://i.imgur.com/bLBkpWR.png');
      }

      const pointData = {
        type: "Feature",
        geometry: { type: "Point", coordinates: [longitude, latitude] },
        properties: {
          name: title,
          description: `${description} ${imageUrls.map(url => `{{${url}}}`).join(' ')}`,
          user
        }
      };

      console.log('Punto enviado:', pointData);

      try {
        const response = await fetch('/.netlify/functions/savePoint', {
          method: 'POST',
          body: JSON.stringify({ layer, point: pointData }),
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error('Error al guardar en Gist');
        const result = await response.json();
        alert('Punto enviado con éxito');

        const marker = L.marker([latitude, longitude], { icon: icons[layer] });
        marker.bindPopup(createPopupContent(title, user), { className: 'custom-popup' });
        marker.on('click', (e) => {
          showDetails(imageUrls, layer);
          L.DomEvent.stopPropagation(e);
        });
        clusterGroups[layer].addLayer(marker);

        toggleMode();
        marker.openPopup();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar. Revisá la consola.');
      }
      submitBtn.disabled = false;
      document.getElementById('savingMessage').style.display = 'none';
    }

    function updateLayers() {
      Object.keys(clusterGroups).forEach(layer => {
        const checkbox = document.getElementById(`${layer}Check`);
        if (checkbox.checked) {
          if (!map.hasLayer(clusterGroups[layer])) {
            clusterGroups[layer].addTo(map);
          }
        } else {
          map.removeLayer(clusterGroups[layer]);
        }
      });
    }

    function selectAllLayers() {
      Object.keys(clusterGroups).forEach(layer => {
        const checkbox = document.getElementById(`${layer}Check`);
        checkbox.checked = true;
        clusterGroups[layer].addTo(map);
      });
    }

    function deselectAllLayers() {
      Object.keys(clusterGroups).forEach(layer => {
        const checkbox = document.getElementById(`${layer}Check`);
        checkbox.checked = false;
        map.removeLayer(clusterGroups[layer]);
      });
      hideDetails();
    }

    loadPoints();
    enableMapClick();
  </script>
</body>
</html>