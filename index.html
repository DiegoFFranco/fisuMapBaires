<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FisuMapBaires</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 400px; width: 100%; }
    #form { margin: 20px 0; }
  </style>
</head>
<body>
  <h1>FisuMapBaires - Reportar Puntos (Anónimos)</h1>
  <!-- Mapa incrustado de uMap -->
  <iframe id="umap" width="100%" height="400px" src="https://umap.openstreetmap.fr/en/map/fisuramap-baires_1185098"></iframe>
  <div id="form">
    <label>Capa:</label>
    <select id="layerSelect">
      <option value="anonimos">Anónimos</option>
    </select><br>
    <label>Descripción:</label>
    <input type="text" id="descriptionInput"><br>
    <label>Foto (opcional):</label>
    <input type="file" id="fileInput" accept="image/*"><br>
    <button onclick="submitToMap()">Enviar Punto</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let lat, lng;

    // Coordenadas fijas por ahora (prueba en Buenos Aires)
    lat = -34.6;
    lng = -58.4;

    async function submitToMap() {
      const layer = document.getElementById('layerSelect').value;
      const description = document.getElementById('descriptionInput').value;
      const fileInput = document.getElementById('fileInput');

      if (!lat || !lng) {
        alert('Ubicación fija por ahora. Próximamente clic en el mapa.');
        return;
      }

      let imageUrl = 'https://i.imgur.com/bLBkpWR.png'; // Default
      if (fileInput.files.length > 0) {
        // Subir a Imgur
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        const response = await fetch('https://api.imgur.com/3/image', {
          method: 'POST',
          headers: { Authorization: 'Client-ID 724f0aaea5b4c6b' }, // Tu Client-ID
          body: formData
        });
        const data = await response.json();
        if (data.success) {
          imageUrl = data.data.link;
        } else {
          console.error('Error en Imgur:', data);
        }
      }

      const pointData = {
        lat,
        lng,
        imageUrl: `{{${imageUrl}}}`,
        layer,
        description
      };

      console.log('Enviando punto:', pointData);
      try {
        const res = await fetch('/.netlify/functions/save-point', {
          method: 'POST',
          body: JSON.stringify(pointData)
        });
        const result = await res.json();
        console.log('Respuesta:', result);
        alert(result.message);
        document.getElementById('umap').src += ''; // Recarga iframe (opcional)
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar. Revisá la consola.');
      }
    }
  </script>
</body>
</html>