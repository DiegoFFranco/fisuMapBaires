<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>fisuMapBaires</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #mapContainer { height: 80vh; width: 100%; }
    #modeTitle { text-align: center; margin: 10px 0; }
    #addPointBtn { position: absolute; top: 10px; right: 10px; z-index: 1000; padding: 5px 10px; }
    #pointForm { display: none; position: absolute; top: 50px; left: 10px; z-index: 1000; background: white; padding: 10px; border: 1px solid #ccc; }
    #pointDetails { display: none; position: absolute; bottom: 10px; left: 10px; z-index: 1000; background: white; padding: 10px; border: 1px solid #ccc; max-width: 300px; }
    #photoContainer img { width: 200px; margin: 5px; cursor: pointer; }
    #imageOverlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
    #imageOverlay img { max-width: 90%; max-height: 90%; }
    #layerControls { position: absolute; top: 50px; right: 10px; z-index: 1000; background: white; padding: 10px; border: 1px solid #ccc; }
    .custom-popup { max-width: 250px; }
  </style>
</head>
<body>
  <h2 id="modeTitle">fisuMapBaires - Modo Visor</h2>
  <button id="addPointBtn" onclick="toggleMode()">Agregar Punto</button>
  <div id="mapContainer"></div>
  <div id="pointForm">
    <label for="layerSelect">Categoría:</label>
    <select id="layerSelect">
      <option value="fisuras">Fisuras</option>
      <option value="limpieza">Limpieza</option>
      <option value="trapitos">Trapitos</option>
      <option value="narcomenudeo">Narcomenudeo</option>
      <option value="casas-tomadas">Casas Tomadas</option>
      <option value="comercios-fisuras">Comercios Fisuras</option>
      <option value="via-publica">Vía Pública</option>
    </select><br>
    <label for="userInput">Usuario:</label>
    <input type="text" id="userInput" placeholder="Anónimo"><br>
    <label for="titleInput">Título:</label>
    <input type="text" id="titleInput"><br>
    <label for="descriptionInput">Descripción:</label>
    <textarea id="descriptionInput"></textarea><br>
    <label for="photoInput">Fotos:</label>
    <input type="file" id="photoInput" accept="image/*" multiple><br>
    <button id="submitBtn" onclick="submitPoint()">Enviar Punto</button>
  </div>
  <div id="pointDetails">
    <h3 id="detailsTitle"></h3>
    <p id="detailsUser"></p>
    <p id="detailsDescription"></p>
    <div id="photoContainer"></div>
  </div>
  <div id="imageOverlay" onclick="hideOverlay()"></div>
  <div id="layerControls">
    <h3>Capas</h3>
    <label><input type="checkbox" id="fisurasCheck" checked onchange="updateLayers()"> Fisuras</label><br>
    <label><input type="checkbox" id="limpiezaCheck" checked onchange="updateLayers()"> Limpieza</label><br>
    <label><input type="checkbox" id="trapitosCheck" checked onchange="updateLayers()"> Trapitos</label><br>
    <label><input type="checkbox" id="narcomenudeoCheck" checked onchange="updateLayers()"> Narcomenudeo</label><br>
    <label><input type="checkbox" id="casasTomadasCheck" checked onchange="updateLayers()"> Casas Tomadas</label><br>
    <label><input type="checkbox" id="comerciosFisurasCheck" checked onchange="updateLayers()"> Comercios Fisuras</label><br>
    <label><input type="checkbox" id="viaPublicaCheck" checked onchange="updateLayers()"> Vía Pública</label><br>
    <label><input type="checkbox" id="comisariasCheck" checked onchange="updateLayers()"> Comisarías</label><br>
    <button onclick="selectAllLayers()">Ver todo</button>
    <button onclick="deselectAllLayers()">Ninguna</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    let latitude, longitude;
    let currentMarker = null;
    let isEditing = false;
    const map = L.map('mapContainer').setView([-34.6, -58.4], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Capas y colores con URLs de Gist reales
    const layersConfig = {
      'fisuras': { 
        color: 'red', 
        fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/1cb1d8e5bf02d884ae4dd0cca5c7ca97/raw/f49f6c20e0ccdd08bd2871f995898c598e830f67/fisuras-fija.geojson', 
        tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/ca1084559d9fc6c5a91a6175d424bd2c/raw/242a03220aa00562f44352a9c0be5261599cf127/fisuras-temporal.geojson' 
      },
      'limpieza': { 
        color: 'green', 
        fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/2c3d4d9e4a21d504b2c268debc71f8ec/raw/bae42a015ca4843013b77ac9a6295f8f4f2f6958/limpieza-fija.geojson', 
        tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/52640ef61feae0ba47fa5c1b50a4bb03/raw/448cc1c4d327316cf770da40361fe2baf9c48205/limpieza-temporal.geojson' 
      },
      'trapitos': { 
        color: 'yellow', 
        fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/3a03f67f71c4a786a77e02272627ca05/raw/b100392c4a8bc36bbf6e8e6afb7684d05ab96c4a/trapitos-fija.geojson', 
        tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/4b5ae0b59d4cbbad161f0234906cb1cd/raw/3472ab3f291b5d20238d58a9218450786e722bfe/trapitos-temporal.geojson' 
      },
      'narcomenudeo': { 
        color: 'purple', 
        fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/5efc8ea5b5a449f028a6a52fa198dbb5/raw/ed5018852c5627baca7c603601c08274368b9d1b/narcomenudeo-fija.geojson', 
        tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/363f43d4842fa35a3357ae2c474a6fff/raw/d308e79bb7ff536b92c67063111625f6c6b38230/narcomenudeo-temporal.geojson' 
      },
      'casas-tomadas': { 
        color: 'orange', 
        fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/302f0ad335f67a6e636191a63d7eb14d/raw/d68c894f8039d8594b2df0123ae0a1536c7073b5/casasTomadas-fija.geojson', 
        tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/9a74c688f462688e1d712989c275d853/raw/845fa838ada35e03044931aba508f35f227c5df3/casasTomadas-temporal.geojson' 
      },
      'comercios-fisuras': { 
        color: 'pink', 
        fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/b9007a080910fab28432b60de9478e6a/raw/3ca9baaad6675af987fe3946090ca9cfa849f419/comerciosFisura-fija.geojson', 
        tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/3a1ca4ff9425fbac6d887aba7e414f98/raw/b1eaef49d7bd786d80d34b964ff544f4a66a1600/comerciosFisura-temporal.geojson' 
      },
      'via-publica': { 
        color: 'gray', 
        fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/daa897ed4fbfba087549e4abea37412c/raw/bf1e734ad457f8a44c25979801b7aef21c4a7d0c/viaPublica-fija.geojson', 
        tempUrl: 'https://gist.githubusercontent.com/DiegoFFranco/79af8d490561594d4bd4f739ae5e9356/raw/785ca5ac955f9a008ac8ebac5da24149201cf6c8/viaPublica-temporal.geojson' 
      },
      'comisarias': { 
        color: 'blue', 
        fixedUrl: 'https://gist.githubusercontent.com/DiegoFFranco/33d1ed2480106a5f6e044720607b01cc/raw/25d9d66d2ea2cba5bcfb7f17171dbab97c3be614/comisarias.geojson', 
        tempUrl: null 
      }
    };

    const clusterGroups = {};
    Object.keys(layersConfig).forEach(layer => {
      clusterGroups[layer] = L.markerClusterGroup({
        iconCreateFunction: cluster => {
          return L.divIcon({
            html: `<span style="background-color: ${layersConfig[layer].color}">${cluster.getChildCount()}</span>`,
            className: 'marker-cluster',
            iconSize: L.point(40, 40)
          });
        }
      });
    });

    function createPopupContent(title, user) {
      return `<b>${title}</b><br>Usuario: ${user}`;
    }

    function showDetails(title, user, description, imageUrls) {
      document.getElementById('pointDetails').style.display = 'block';
      document.getElementById('detailsTitle').textContent = title;
      document.getElementById('detailsUser').textContent = `Usuario: ${user}`;
      document.getElementById('detailsDescription').textContent = description;
      const photoContainer = document.getElementById('photoContainer');
      photoContainer.innerHTML = '';
      imageUrls.forEach(url => {
        const img = document.createElement('img');
        img.src = url;
        img.onclick = () => showOverlay(url);
        photoContainer.appendChild(img);
      });
    }

    function hideOverlay() {
      document.getElementById('imageOverlay').style.display = 'none';
    }

    function showOverlay(url) {
      const overlay = document.getElementById('imageOverlay');
      overlay.innerHTML = `<img src="${url}">`;
      overlay.style.display = 'flex';
    }

    function hideDetails() {
      document.getElementById('pointDetails').style.display = 'none';
    }

    async function loadPoints() {
      for (const layer in layersConfig) {
        const config = layersConfig[layer];
        clusterGroups[layer].clearLayers();

        try {
          const fixedResponse = await fetch(config.fixedUrl);
          const fixedData = await fixedResponse.json();
          L.geoJSON(fixedData, {
            pointToLayer: (feature, latlng) => {
              return L.circleMarker(latlng, { radius: 8, fillColor: config.color, color: config.color, weight: 1, opacity: 1, fillOpacity: 0.8 });
            },
            onEachFeature: (feature, layer) => {
              const { name, description, user } = feature.properties;
              const imageUrls = description.match(/{{https:\/\/i\.imgur\.com\/\w+\.(?:jpg|png|jpeg)}}/g)?.map(url => url.slice(2, -2)) || [];
              layer.bindPopup(createPopupContent(name, user), { className: 'custom-popup' });
              layer.on('click', (e) => {
                showDetails(name, user, description.replace(/{{https:\/\/i\.imgur\.com\/\w+\.(?:jpg|png|jpeg)}}/g, ''), imageUrls);
                L.DomEvent.stopPropagation(e);
              });
            }
          }).addTo(clusterGroups[layer]);
        } catch (e) { console.log(`No hay datos fijos para ${layer}`); }

        if (config.tempUrl) {
          try {
            const tempResponse = await fetch(config.tempUrl);
            const tempData = await tempResponse.json();
            L.geoJSON(tempData, {
              pointToLayer: (feature, latlng) => {
                return L.circleMarker(latlng, { radius: 8, fillColor: config.color, color: config.color, weight: 1, opacity: 1, fillOpacity: 0.8 });
              },
              onEachFeature: (feature, layer) => {
                const { name, description, user } = feature.properties;
                const imageUrls = description.match(/{{https:\/\/i\.imgur\.com\/\w+\.(?:jpg|png|jpeg)}}/g)?.map(url => url.slice(2, -2)) || [];
                layer.bindPopup(createPopupContent(name, user), { className: 'custom-popup' });
                layer.on('click', (e) => {
                  showDetails(name, user, description.replace(/{{https:\/\/i\.imgur\.com\/\w+\.(?:jpg|png|jpeg)}}/g, ''), imageUrls);
                  L.DomEvent.stopPropagation(e);
                });
              }
            }).addTo(clusterGroups[layer]);
          } catch (e) { console.log(`No hay datos temporales para ${layer}`); }
        }

        if (document.getElementById(`${layer.replace('-', '')}Check`).checked) {
          clusterGroups[layer].addTo(map);
        }
      }
    }

    function enableMapClick() {
      map.on('click', (event) => {
        if (isEditing) {
          latitude = event.latlng.lat;
          longitude = event.latlng.lng;
          if (currentMarker) map.removeLayer(currentMarker);
          currentMarker = L.marker([latitude, longitude]).addTo(map);
        } else {
          hideDetails();
        }
      });
    }

    function disableMapClick() {
      map.off('click');
      if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
      }
    }

    function toggleMode() {
      if (isEditing) {
        isEditing = false;
        document.getElementById('modeTitle').textContent = 'fisuMapBaires - Modo Visor';
        document.getElementById('pointForm').style.display = 'none';
        document.getElementById('addPointBtn').textContent = 'Agregar Punto';
        document.getElementById('pointDetails').style.display = 'none';
        document.getElementById('layerControls').style.display = 'block';
        disableMapClick();
        enableMapClick();
      } else {
        isEditing = true;
        document.getElementById('modeTitle').textContent = 'fisuMapBaires - Modo Edición';
        document.getElementById('pointForm').style.display = 'block';
        document.getElementById('addPointBtn').textContent = 'Volver a Visor';
        document.getElementById('pointDetails').style.display = 'none';
        document.getElementById('layerControls').style.display = 'none';
        enableMapClick();
      }
    }

    async function submitPoint() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;

      const layer = document.getElementById('layerSelect').value;
      const user = document.getElementById('userInput').value || 'Anónimo';
      const title = document.getElementById('titleInput').value;
      const description = document.getElementById('descriptionInput').value;
      const photoInput = document.getElementById('photoInput');

      if (!latitude || !longitude) {
        alert('Hacé clic en el mapa para elegir una ubicación.');
        submitBtn.disabled = false;
        return;
      }

      if (!title) {
        alert('Ingresá un título para el punto.');
        submitBtn.disabled = false;
        return;
      }

      let imageUrls = [];
      if (photoInput.files.length > 0) {
        for (const file of photoInput.files) {
          const formData = new FormData();
          formData.append('image', file);
          const response = await fetch('https://api.imgur.com/3/image', {
            method: 'POST',
            headers: { Authorization: 'Client-ID 724f0aaea5b4c6b' },
            body: formData
          });
          const data = await response.json();
          if (data.success) imageUrls.push(data.data.link);
          else console.error('Error en Imgur:', data);
        }
      } else {
        imageUrls.push('https://i.imgur.com/bLBkpWR.png');
      }

      const pointData = {
        type: "Feature",
        geometry: { type: "Point", coordinates: [longitude, latitude] },
        properties: {
          name: title,
          description: `${description} ${imageUrls.map(url => `{{${url}}}`).join(' ')}`,
          user
        }
      };

      console.log('Punto enviado:', pointData);

      try {
        const response = await fetch('/.netlify/functions/savePoint', {
          method: 'POST',
          body: JSON.stringify({ layer, point: pointData }),
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error('Error al guardar en Gist');
        alert('Punto enviado con éxito');

        const marker = L.circleMarker([latitude, longitude], {
          radius: 8,
          fillColor: layersConfig[layer].color,
          color: layersConfig[layer].color,
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        });
        marker.bindPopup(createPopupContent(title, user), { className: 'custom-popup' });
        marker.on('click', (e) => {
          showDetails(title, user, description, imageUrls);
          L.DomEvent.stopPropagation(e);
        });
        clusterGroups[layer].addLayer(marker);

        toggleMode();
        marker.openPopup();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar. Revisá la consola.');
      }
      submitBtn.disabled = false;
    }

    function updateLayers() {
      Object.keys(clusterGroups).forEach(layer => {
        const checkbox = document.getElementById(`${layer.replace('-', '')}Check`);
        if (checkbox.checked) {
          if (!map.hasLayer(clusterGroups[layer])) {
            clusterGroups[layer].addTo(map);
          }
        } else {
          map.removeLayer(clusterGroups[layer]);
        }
      });
    }

    function selectAllLayers() {
      Object.keys(clusterGroups).forEach(layer => {
        const checkbox = document.getElementById(`${layer.replace('-', '')}Check`);
        checkbox.checked = true;
        clusterGroups[layer].addTo(map);
      });
    }

    function deselectAllLayers() {
      Object.keys(clusterGroups).forEach(layer => {
        const checkbox = document.getElementById(`${layer.replace('-', '')}Check`);
        checkbox.checked = false;
        map.removeLayer(clusterGroups[layer]);
      });
    }

    loadPoints();
    enableMapClick();
  </script>
</body>
</html>