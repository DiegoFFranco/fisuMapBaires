<style>
  /* ... (resto igual) */
  #imageOverlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; cursor: pointer; }
  /* ... (resto igual) */
</style>

<body>
  <!-- ... (resto igual) -->
  <div id="imageOverlay" onclick="hideOverlay()"></div>
  <!-- ... (resto igual) -->
</body>

<script>
  // ... (resto igual)

  function hideOverlay() { // Simplificado, sin 'event'
    document.getElementById('imageOverlay').style.display = 'none';
  }

  function showOverlay(url, layer, imageUrls, index) {
    currentImages = imageUrls;
    currentImageIndex = index;
    const overlay = document.getElementById('imageOverlay');
    overlay.innerHTML = `
      <span class="nav-arrow prev" onclick="navigateImages(-1, '${layer}'); event.stopPropagation();">◄</span>
      <img src="${url}" style="border-color: ${layersConfig[layer].color}">
      <span class="nav-arrow next" onclick="navigateImages(1, '${layer}'); event.stopPropagation();">►</span>
    `;
    overlay.style.display = 'flex';
  }

  function navigateImages(direction, layer) {
    currentImageIndex += direction;
    if (currentImageIndex < 0) currentImageIndex = currentImages.length - 1;
    if (currentImageIndex >= currentImages.length) currentImageIndex = 0;
    const overlay = document.getElementById('imageOverlay');
    overlay.innerHTML = `
      <span class="nav-arrow prev" onclick="navigateImages(-1, '${layer}'); event.stopPropagation();">◄</span>
      <img src="${currentImages[currentImageIndex]}" style="border-color: ${layersConfig[layer].color}">
      <span class="nav-arrow next" onclick="navigateImages(1, '${layer}'); event.stopPropagation();">►</span>
    `;
  }

  function toggleMode(lastCreatedLayer = null) {
    if (isEditing) {
      isEditing = false;
      document.getElementById('modeTitle').textContent = 'fisuMapBaires - Modo Visor';
      document.getElementById('pointForm').style.display = 'none';
      document.getElementById('addPointBtn').textContent = 'Agregar Punto';
      document.getElementById('pointDetails').style.display = 'none';
      document.getElementById('layerControls').style.display = 'block';
      disableMapClick();
      enableMapClick();
      document.getElementById('addressInput').value = '';
      document.getElementById('userInput').value = '';
      document.getElementById('titleInput').value = '';
      document.getElementById('descriptionInput').value = '';
      document.getElementById('photoInput').value = '';
      if (lastCreatedLayer) {
        // Forzar la capa del punto creado como visible
        Object.keys(clusterGroups).forEach(layer => {
          if (layer === lastCreatedLayer) {
            document.getElementById(`${layer}Check`).checked = true;
            clusterGroups[layer].addTo(map);
          } else if (!document.getElementById(`${layer}Check`).checked) {
            map.removeLayer(clusterGroups[layer]);
          }
        });
      } else {
        updateLayers();
      }
    } else {
      isEditing = true;
      document.getElementById('modeTitle').textContent = 'fisuMapBaires - Modo Edición';
      document.getElementById('pointForm').style.display = 'block';
      document.getElementById('addPointBtn').textContent = 'Volver a Visor';
      document.getElementById('pointDetails').style.display = 'none';
      document.getElementById('layerControls').style.display = 'none';
      enableMapClick();
      updateEditorLayer();
    }
  }

  async function submitPoint() {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    document.getElementById('savingMessage').style.display = 'block';

    const layer = document.getElementById('layerSelect').value;
    const user = document.getElementById('userInput').value || 'Anónimo';
    const title = document.getElementById('titleInput').value;
    const description = document.getElementById('descriptionInput').value;
    const photoInput = document.getElementById('photoInput');
    const files = photoInput.files;

    if (!latitude || !longitude) {
      alert('Hacé clic en el mapa, buscá una dirección o usá tu ubicación actual.');
      submitBtn.disabled = false;
      document.getElementById('savingMessage').style.display = 'none';
      return;
    }

    if (!title) {
      alert('Ingresá un título para el punto.');
      submitBtn.disabled = false;
      document.getElementById('savingMessage').style.display = 'none';
      return;
    }

    if (files.length > 5) {
      alert('Máximo 5 fotos permitidas.');
      submitBtn.disabled = false;
      document.getElementById('savingMessage').style.display = 'none';
      return;
    }

    let imageUrls = [];
    if (files.length > 0) {
      for (const file of files) {
        const validTypes = ['image/jpeg', 'image/png'];
        if (!validTypes.includes(file.type)) {
          alert(`Formato no soportado: ${file.name}. Usá JPG o PNG.`);
          submitBtn.disabled = false;
          document.getElementById('savingMessage').style.display = 'none';
          return;
        }
        const formData = new FormData();
        formData.append('image', file);
        try {
          const response = await fetch('https://api.imgur.com/3/image', {
            method: 'POST',
            headers: { Authorization: 'Client-ID 724f0aaea5b4c6b' },
            body: formData
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error en Imgur: ${response.status} - ${errorText}`);
          }
          const data = await response.json();
          if (data.success) {
            imageUrls.push(data.data.link);
          } else {
            throw new Error('Imgur no devolvió éxito');
          }
        } catch (e) {
          console.error('Error en Imgur:', e);
          alert(`Error subiendo una foto: ${e.message}. Revisá los formatos e intentá de nuevo.`);
          submitBtn.disabled = false;
          document.getElementById('savingMessage').style.display = 'none';
          return;
        }
      }
    } else {
      imageUrls.push('https://i.imgur.com/bLBkpWR.png');
    }

    const pointData = {
      type: "Feature",
      geometry: { type: "Point", coordinates: [longitude, latitude] },
      properties: {
        name: title,
        description: `${description} ${imageUrls.map(url => `{{${url}}}`).join(' ')}`,
        user
      }
    };

    console.log('Punto enviado:', pointData);

    try {
      const response = await fetch('/.netlify/functions/savePoint', {
        method: 'POST',
        body: JSON.stringify({ layer, point: pointData }),
        headers: { 'Content-Type': 'application/json' }
      });
      if (!response.ok) throw new Error('Error al guardar en Gist');
      const result = await response.json();

      const marker = L.marker([latitude, longitude], { icon: icons[layer] });
      marker.bindPopup(createPopupContent(title, user), { className: 'custom-popup' });
      marker.on('click', (e) => {
        showDetails(imageUrls, layer);
        L.DomEvent.stopPropagation(e);
      });
      clusterGroups[layer].addLayer(marker);
      if (!map.hasLayer(clusterGroups[layer])) {
        clusterGroups[layer].addTo(map);
      }

      alert('Punto enviado con éxito');
      toggleMode(layer); // Pasamos la capa creada
      marker.openPopup();
    } catch (error) {
      console.error('Error:', error);
      alert('Error al enviar. Revisá la consola.');
    }
    submitBtn.disabled = false;
    document.getElementById('savingMessage').style.display = 'none';
  }

  // ... (resto igual)
</script>